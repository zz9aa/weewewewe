(function () {
    'use strict';

    let notificationPopupTimeout;
    function showNotification(message, duration = 2000) {
        const existingNotification = document.getElementById('notification-popup');
        if (existingNotification) {
            existingNotification.remove();
            clearTimeout(notificationPopupTimeout);
        }

        const popup = document.createElement('div');
        popup.id = 'notification-popup';
        popup.innerText = message;
        Object.assign(popup.style, {
            position: 'fixed',
            top: '20px',
            left: '50%',
            transform: 'translateX(-50%)',
            backgroundColor: '#4CAF50',
            color: 'white',
            padding: '8px 15px',
            borderRadius: '5px',
            boxShadow: '0 2px 5px rgba(0, 0, 0, 0.2)',
            zIndex: '10001',
            opacity: '0.9',
            transition: 'opacity 0.3s ease-in-out'
        });
        document.body.appendChild(popup);

        notificationPopupTimeout = setTimeout(() => {
            popup.style.opacity = '0';
            setTimeout(() => popup.remove(), 300);
        }, duration);
    }

    const VERIFICATION_COOKIE_NAME = "zzaa";
    const VERIFICATION_COOKIE_VALUE = "zzaa";

    const firebaseConfig = {
        apiKey: "AIzaSyCzfEgRutixv74_ydXBJmu8ImLNDcduoVk",
        authDomain: "hehehaha-dda0e.firebaseapp.com",
        databaseURL: "https://hehehaha-dda0e-default-rtdb.firebaseio.com",
        projectId: "hehehaha-dda0e",
        storageBucket: "hehehaha-dda0e.firebasestorage.app",
        messagingSenderId: "475557136805",
        appId: "1:475557136805:web:463e7fcb0ad8d51f69004c",
        measurementId: "G-PTF35KXD5C"
    };

    let currentUserId = null;
    let firebaseReady = false;
    let dbInstance = null;
    let authInstance = null;
    let scriptEnabled = false;
    let featuresInitialized = false;

    function loadScript(url, callback) {
        GM_xmlhttpRequest({
            method: "GET",
            url: url,
            onload: function (response) {
                try {
                    eval(response.responseText);
                    if (callback) callback();
                } catch (e) {
                    console.error(`Failed to evaluate script from ${url}:`, e);
                }
            },
            onerror: function (response) {
                console.error(`Failed to load script from ${url}:`, response);
            }
        });
    }

    loadScript("https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js", () => {
        loadScript("https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js", () => {
            loadScript("https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js", () => {

                firebase.initializeApp(firebaseConfig);
                dbInstance = firebase.database();
                authInstance = firebase.auth();

                authInstance.signInAnonymously()
                    .then((userCredential) => {
                        currentUserId = userCredential.user.uid;
                        console.log('Firebase user authenticated:', currentUserId);
                        firebaseReady = true;

                        if (isVerified()) {
                            checkControlStatus();
                        } else {
                            console.log("Verification cookie not found. Script functionality disabled.");
                        }
                    })
                    .catch((error) => {
                        console.error('Firebase authentication error:', error);
                        showNotification(`Authentication error: ${error.message || error.code}`, 5000);
                    });
            });
        });
    });

    let mainPopupTimeout;

    function showPopup(content, permanent = false) {
        const existingMainPopup = document.getElementById('main-answers-popup');
        if (existingMainPopup) {
            existingMainPopup.remove();
            clearTimeout(mainPopupTimeout);
        }

        if (!scriptEnabled) return;

        const popup = document.createElement('div');
        popup.id = 'main-answers-popup';
        popup.innerText = content;
        Object.assign(popup.style, {
            position: 'fixed',
            bottom: '10px',
            right: '10px',
            padding: '10px',
            backgroundColor: 'rgba(0, 0, 0, 0.7)',
            color: '#fff',
            borderRadius: '15px',
            zIndex: '10000',
            fontSize: '14px',
            maxWidth: '300px',
            wordWrap: 'break-word',
            fontFamily: 'Arial, sans-serif',
            boxShadow: '0 2px 10px rgba(0, 0, 0, 0.5)',
            transition: 'opacity 0.3s ease-in-out'
        });

        document.body.appendChild(popup);

        if (!permanent) {
            mainPopupTimeout = setTimeout(() => {
                popup.style.opacity = '0';
                setTimeout(() => popup.remove(), 200);
            }, 200);

            popup.addEventListener('mouseover', () => {
                clearTimeout(mainPopupTimeout);
                popup.style.opacity = '1';
            });
            popup.addEventListener('mouseout', () => {
                mainPopupTimeout = setTimeout(() => {
                    popup.style.opacity = '0';
                    setTimeout(() => popup.remove(), 200);
                }, 200);
            });
        }
    }

    function isVerified() {
        const cookies = document.cookie.split('; ');
        for (const cookie of cookies) {
            const [name, value] = cookie.split('=');
            if (name === VERIFICATION_COOKIE_NAME && value === VERIFICATION_COOKIE_VALUE) {
                return true;
            }
        }
        return false;
    }

    let controlButtons = [];
    let areButtonsVisible = false;

    function removeControlButtons() {
        controlButtons.forEach(button => button.remove());
        controlButtons = [];
    }

    function setScriptEnabled(enable, reason = '') {
        if (scriptEnabled === enable) return;

        scriptEnabled = enable;

        if (enable) {
            showNotification(`Script Enabled${reason ? `: ${reason}` : ''}`, 1500);
            initializeUserScriptFeatures();

            if (controlButtons.length > 0 && areButtonsVisible) {
                controlButtons.forEach(button => {
                    button.style.display = 'block';
                    button.style.opacity = '1';
                });
            } else if (controlButtons.length > 0) {
                 controlButtons.forEach(button => {
                    button.style.display = 'block';
                    button.style.opacity = '0';
                });
            }

        } else {
            showNotification(`Script Disabled${reason ? `: ${reason}` : ''}`, 3000);
            controlButtons.forEach(button => button.style.display = 'none');
            const existingMainPopup = document.getElementById('main-answers-popup');
            if (existingMainPopup) existingMainPopup.remove();
        }
    }

    function checkControlStatus() {
        if (!firebaseReady || !currentUserId || !dbInstance) return;

        const globalStatusRef = dbInstance.ref('control/globalStatus');
        const userStatusRef = dbInstance.ref(`control/disabledUsers/${currentUserId}`);

        Promise.all([globalStatusRef.once('value'), userStatusRef.once('value')]).then(([globalSnap, userSnap]) => {
            const status = globalSnap.val();
            const blocked = userSnap.val() === true;

            if (status === 'off') {
                 setScriptEnabled(false, "Global Kill Switch Active");
            } else if (blocked) {
                 setScriptEnabled(false, "User Blocked by Admin");
            } else {
                 setScriptEnabled(true, "Ready");
            }
        }).catch(err => {
             console.error("Initial control check failed:", err);
             setScriptEnabled(true, "Control Check Failed - Defaulting to Ready");
        });

        globalStatusRef.on('value', (snapshot) => {
            const status = snapshot.val();
            userStatusRef.once('value').then(userSnap => {
                 const blocked = userSnap.val() === true;

                 if (status === 'off') {
                    setScriptEnabled(false, "Global Kill Switch Activated");
                 } else if (blocked) {
                     setScriptEnabled(false, "User Blocked by Admin");
                 } else {
                     setScriptEnabled(true, "Global Status Restored");
                 }
            });
        });

        userStatusRef.on('value', (snapshot) => {
            globalStatusRef.once('value').then(globalSnap => {
                if (globalSnap.val() === 'off') return;

                if (snapshot.val() === true) {
                    setScriptEnabled(false, "User Blocked by Admin");
                } else {
                    if (globalSnap.val() !== 'off') {
                        setScriptEnabled(true, "User Block Removed");
                    }
                }
            });
        });
    }


    function initializeUserScriptFeatures() {
        if (featuresInitialized) return;
        featuresInitialized = true;

        if (!scriptEnabled) return;


        async function loadAnswersFromFirebase() {
            if (!scriptEnabled) {
                showNotification('Script is currently disabled.', 1500);
                return;
            }
            if (!firebaseReady || !currentUserId || !dbInstance) {
                showNotification('Firebase not ready or user not authenticated yet. Cannot load.', 3000);
                return;
            }

            const userAnswersRef = dbInstance.ref(`users/${currentUserId}/answers`);
            try {
                const snapshot = await userAnswersRef.once('value');
                const savedAnswersObject = snapshot.val();

                let answersToDisplay = [];
                if (savedAnswersObject) {
                    answersToDisplay = Object.values(savedAnswersObject).sort((a, b) => {
                        const numA = parseInt(a.match(/^(\d+)\./)?.[1] || 0);
                        const numB = parseInt(b.match(/^(\d+)\./)?.[1] || 0);
                        return numA - numB;
                    });
                }

                if (answersToDisplay.length > 0) {
                    showPopup(answersToDisplay.join('\n'), false);
                } else {
                    showPopup('No saved answers found for this user in the database.', false);
                }
            } catch (error) {
                console.error('Error loading answers from Firebase:', error);
                showNotification('Failed to load answers from Firebase.');
            }
        }

        async function clearAnswersInFirebase() {
            if (!scriptEnabled) {
                showNotification('Script is currently disabled.', 1500);
                return;
            }
            if (!firebaseReady || !currentUserId || !dbInstance) {
                showNotification('Firebase not ready or user not authenticated yet. Cannot clear.', 3000);
                return;
            }

            const userAnswersRef = dbInstance.ref(`users/${currentUserId}/answers`);
            try {
                await userAnswersRef.remove();
                const existingMainPopup = document.getElementById('main-answers-popup');
                if (existingMainPopup) existingMainPopup.remove();
                showNotification('All saved answers cleared from database!', 1000);
            } catch (error) {
                console.error('Error clearing answers from Firebase:', error);
                showNotification('Failed to clear answers from database.');
            }
        }

        function processReceivedData(data) {
            if (!scriptEnabled) return;

            if (!currentUserId || !dbInstance) {
                console.warn('Firebase user not authenticated or DB not initialized. Cannot save new answers.');
                return;
            }

            if (!Array.isArray(data)) {
                console.warn('processReceivedData received non-array data:', data);
                return;
            }

            data.forEach((item, indexx) => {
                const qActivity = (item.activity || "").toLowerCase();

                if (!(qActivity.startsWith("exit") ||
                    qActivity.startsWith("et") ||
                    qActivity.startsWith("flipped") ||
                    qActivity.startsWith("fc"))) {
                    return;
                }

                const questionId = item.question || (item.questions && item.questions.id);
                if (!questionId) {
                    console.warn("Skipping item, no questionId:", item);
                    return;
                }

                GM_xmlhttpRequest({
                    method: "GET",
                    url: `https://blb2024-o5xlbifnea-uc.a.run.app/questions/${questionId}`,
                    headers: {
                        "accept": "*/*",
                        "content-type": "application/json",
                        "origin": "https://student.nis-blb.com",
                        "referer": "https://student.nis-blb.com/",
                        "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6IkFiZGVscmFobWFuIE9zYW1hIEdoYXR0YXMgQWJvemVpZCIsImlkIjoxMDAzNDMyMywicm9sZSI6InN0dWRlbnQiLCJjb2hvcnQiOjM5NiwiYnlfc3ViamVjdCI6bnVsbCwiZ3JhZGUiOjE1LCJjbGFzc3Jvb20iOjEyOCwidG9rZW5WZXJzaW9uIjowLCJpYXQiOjE3NjM4MjMyNzcsImV4cCI6MTc2NDQyODA3N30.EXrC8849t0AvPDtrxnpWQbf1f9aGg4IjG4Vs63-3WyQ",
                        "type": "student"
                    },
                    onload: function (response) {
                        if (response.status !== 200) {
                            console.error(`API request for question ${questionId} failed! Status: ${response.status}`);
                            return;
                        }

                        try {
                            const qdata = JSON.parse(response.responseText);
                            if (!qdata || typeof qdata.type === "undefined") {
                                console.warn(`Invalid qdata for ${questionId}:`, qdata);
                                return;
                            }

                            let answerString = '';
                            if (qdata.type === "True/False") {
                                answerString = qdata.answer === "Right" ? "✅ Right" : "❌ Wrong";
                            } else if (qdata.type === "Multiple Choice") {
                                const options = qdata.questions_options || [];
                                const correctOption = options.find(opt => opt.correct);
                                if (correctOption) {
                                    const labels = ["A", "B", "C", "D", "E", "F", "G"];
                                    const idx = options.indexOf(correctOption);
                                    answerString = `${labels[idx] || idx + 1}) ${correctOption.title}`;
                                }
                            }

                            if (answerString) {
                                const answerFormattedForDB = `${indexx + 1}. ${answerString}`;
                                dbInstance.ref(`users/${currentUserId}/answers/${questionId}`).set(answerFormattedForDB);
                                console.log(`✅ Saved Q${questionId}:`, answerFormattedForDB);
                            }
                        } catch (err) {
                            console.error(`Error parsing API response for ${questionId}:`, err);
                        }
                    }
                });
            });
        }


        function createButton(text, top, action, isRight = false) {
            const button = document.createElement('button');
            button.innerText = text;
            Object.assign(button.style, {
                position: 'fixed',
                top: top,
                left: isRight ? 'auto' : '10px',
                right: isRight ? '10px' : 'auto',
                zIndex: '9999',
                padding: '8px',
                backgroundColor: 'rgba(0, 0, 0, 0.5)',
                color: '#fff',
                border: 'none',
                borderRadius: '5px',
                cursor: 'pointer',
                opacity: '0',
                transition: 'opacity 0.5s ease, box-shadow 0.3s ease',
                display: 'block'
            });

            button.onclick = action;
            button.addEventListener('mouseover', () => {
                if (scriptEnabled) button.style.opacity = '1';
            });
            button.addEventListener('mouseout', () => {
                if (scriptEnabled && !areButtonsVisible) button.style.opacity = '0';
            });
            document.body.appendChild(button);
            controlButtons.push(button);
            return button;
        }

        function createSaveButton() {
            createButton('S', '10px', loadAnswersFromFirebase);
        }

        function createClearButton() {
            createButton('Clear', '45px', clearAnswersInFirebase);
        }

        function createLoadButton() {
            createButton('Load', '80px', loadAnswersFromFirebase, true);
        }

        function toggleButtonsVisibility() {
            if (!scriptEnabled) {
                 showNotification('Script is disabled, cannot toggle buttons.', 1500);
                 return;
            }

            if (areButtonsVisible) {
                controlButtons.forEach(button => {
                    button.style.opacity = '0';
                    button.classList.remove('glow-animation');
                });
                showNotification("Buttons hidden", 500);
            } else {
                controlButtons.forEach(button => {
                    button.style.display = 'block';
                    button.style.opacity = '1';
                    button.classList.add('glow-animation');
                    setTimeout(() => {
                        button.classList.remove('glow-animation');
                    }, 500);
                });
            }
            areButtonsVisible = !areButtonsVisible;
        }


        if (!window.__fetch_modified__) {
            const originalFetch = window.fetch;
            window.fetch = function () {
                return originalFetch.apply(this, arguments).then(async response => {
                    if (scriptEnabled) {
                        const clonedResponse = response.clone();
                        try {
                            const jsonData = await clonedResponse.json();
                            if (Array.isArray(jsonData)) {
                                processReceivedData(jsonData);
                            }
                        } catch (e) { }
                    }
                    return response;
                });
            };
            window.__fetch_modified__ = true;
        }

        if (!window.__xhr_modified__) {
            const originalXHR = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function () {
                this.addEventListener('load', function () {
                    if (!scriptEnabled) return;

                    let responseData;
                    if (this.responseType === 'arraybuffer' && this.response) {
                        try {
                             responseData = JSON.parse(new TextDecoder('utf-8').decode(this.response));
                        } catch (e) { }
                    } else if (this.responseType === '' || this.responseType === 'text') {
                        try {
                             responseData = JSON.parse(this.responseText);
                        } catch (e) { }
                    } else if (this.responseType === 'json' && this.response) {
                        responseData = this.response;
                    }

                    if (responseData && Array.isArray(responseData)) {
                        processReceivedData(responseData);
                    }
                });
                return originalXHR.apply(this, arguments);
            };
            window.__xhr_modified__ = true;
        }

        const styleId = 'user-script-style';
        if (!document.getElementById(styleId)) {
            const style = document.createElement('style');
            style.id = styleId;
            style.textContent = `
                @keyframes rainbow-glow {
                    0% { box-shadow: 0 0 12px 3px rgba(255, 0, 0, 0.8); }
                    14% { box-shadow: 0 0 12px 3px rgba(255, 127, 0, 0.8); }
                    28% { box-shadow: 0 0 12px 3px rgba(255, 255, 0, 0.8); }
                    42% { box-shadow: 0 0 12px 3px rgba(0, 255, 0, 0.8); }
                    57% { box-shadow: 0 0 12px 3px rgba(0, 0, 255, 0.8); }
                    71% { box-shadow: 0 0 12px 3px rgba(75, 0, 130, 0.8); }
                    85% { box-shadow: 0 0 12px 3px rgba(148, 0, 211, 0.8); }
                    100% { box-shadow: 0 0 12px 3px rgba(255, 0, 0, 0.8); }
                }
                .glow-animation {
                    animation: rainbow-glow 0.5s ease-in-out;
                }
            `;
            document.head.appendChild(style);
        }

        removeControlButtons();
        createSaveButton();
        createClearButton();
        createLoadButton();


        if (!window.__keyboard_listeners_set__) {
            document.addEventListener('keydown', (e) => {
                if (!scriptEnabled) return;

                if (e.ctrlKey && e.key === '0') {
                    e.preventDefault();
                    toggleButtonsVisibility();
                }
            });

            document.addEventListener('keydown', (key) => {
                if (!scriptEnabled) return;

                if (key.ctrlKey && key.key === '8') {
                    key.preventDefault();
                    clearAnswersInFirebase();
                }
            });

            document.addEventListener('keydown', (key) => {
                if (!scriptEnabled) return;

                if (key.ctrlKey && key.key === '9') {
                    key.preventDefault();
                    loadAnswersFromFirebase();
                }
            });
            window.__keyboard_listeners_set__ = true;
        }
    }
})();
